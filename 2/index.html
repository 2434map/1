<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
<script src="config.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
<link rel="shortcut icon" href="images/favicon.ico" type="image/vnd.microsoft.icon">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-145408095-1"></script>
<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'UA-145408095-1');
</script>
<title>にじさんじサーバ通常地図</title>
</head><body>
<nav>
<ul>
<li class="current"><a href="./">通常地図</a></li>
<li><a href="./all2.html#zoom=19.92753623188406&x=0.8067259594949632&y=0.6080154476736246">全体地図</a></li>
<li><a href="Nether.html">ネザー地図</a></li>
<li><a href="New.html">新規ワールド</a></li>
<li><a href="New_Nether.html">新規ワールドネザー</a></li>
</ul>
<img src="images/center.gif">
</nav>
<main id="main"></main>
<script type="text/javascript">

	var vh = 6400;
	var vw = 9067;

	var viewer = OpenSeadragon({
		id: "main", 
		prefixUrl: "images/", 
		showNavigator: true, 
		tileSources: {
			Image: {
				xmlns:    "http://schemas.microsoft.com/deepzoom/2008",
				Url:      "tiles/",
				Format:   "jpg", 
				Overlap:  1, 
				TileSize: 256,
				Size: {
					Height: vh,
					Width:  vw
				}
			}
		}
	});
	viewer.bookmarkUrl();// 座標URL
	viewer.stalkerImage();// アニメーションポインター
	//viewer.markerLink('marker.csv', vw);// CSVマーカー

		var mh = 36;
		var mw = 36;

		var parseHash = function() {
			var params = {};
			var hash = window.location.hash.replace(/^#/, '');
			if (hash) {
				var parts = hash.split('&');
				parts.forEach(function(part) {
					var subparts = part.split('=');
					var key = subparts[0];
					var value = parseFloat(subparts[1]);
					if (!key || isNaN(value)) {
						console.error('bad hash param', part);
					} else {
						params[key] = value;
					}
				});
			}
			return params;
		};

		var params = parseHash();


		var markerfile = "marker.csv";
		var marker = [];
		function readMarkerCsv(data) {
			var csv = jQuery.csv.toArrays(data);
			for(var i=0; i<csv.length; i++) if(i>0) marker.push(csv[i]);
		}
		jQuery.get(markerfile, readMarkerCsv, 'text');// マーカー情報

		jQuery(document).ajaxStop(function() {
			var hEl = viewer.HTMLelements();
			var M = [];

			for(var i=0; i<marker.length; i++){
				M[i] = document.createElement("a");
				M[i].className = "marker markerOn";
				M[i].setAttribute("href",marker[i][3]);
				M[i].setAttribute("title",marker[i][2]);
				M[i].setAttribute("target","_blank");


/*
					M[i].style.display='block';
				if (params.zoom !== undefined && params.zoom > 0.5) {
					M[i].style.display='block';
				} else {
					M[i].style.display='none';
				}
*/

				hEl.addElement({
					id: "M"+String(i),
					element: M[i],
					x: Math.round(marker[i][0]*w)-Math.round(mw/2),
					y: Math.round(marker[i][1]*w)-Math.round(mh/2),
					width: mw,
					height: mh
				})
				new OpenSeadragon.MouseTracker({element: M[i], clickHandler: onMarker});
			}

			function onMarker(e){
				var target = e.originalEvent.target;
				if (target.matches('a')) {
					if (target.getAttribute('target') === '_blank') window.open(target.getAttribute('href'));
					else location.href = target.getAttribute('href');
				}
			}
/*
			// 変化検知
			var imagingHelper = self.activateImagingHelper({onImageViewChanged: onImageViewChanged});
			function onImageViewChanged(event) {
				var params = parseHash();

				if (params.zoom !== undefined && params.zoom > 0.5) {
					if(jQuery('.markerOn').length) jQuery("a.marker").css('display','block');
				} else {
					jQuery("a.marker").css('display','none');
				}

				//alert(self.imagingHelper.getZoomFactor());

				if(self.imagingHelper.getZoomFactor() > 0.5){
					if(jQuery('.markerOn').length) jQuery("a.marker").css('display','block');
				} else {
					jQuery("a.marker").css('display','none');
				}


			}
*/

			let markerButton = new OpenSeadragon.Button({
				tooltip:  'Marker',
				srcRest:  'images/marker_rest.png',
				srcGroup: 'images/marker_grouphover.png',
				srcHover: 'images/marker_hover.png',
				srcDown:  'images/marker_pressed.png',
				onClick: markerChange
			});
			//self.addControl(markerButton.element, { anchor: OpenSeadragon.ControlAnchor.TOP_LEFT });
			viewer.buttons.buttons.push(markerButton);
			viewer.buttons.element.appendChild(markerButton.element);

			function markerChange(){
				if  (jQuery('.markerOn').length){ 
					jQuery("a.marker").removeClass('markerOn');
					jQuery("a.marker").css('display','none');
				} else {
					jQuery("a.marker").addClass('markerOn');
					var params = parseHash();
					if (params.zoom !== undefined && params.zoom > 0.5) {
					//if(imagingHelper.getZoomFactor() > 0.5){
						jQuery("a.marker").css('display','block');
					} else {
						jQuery("a.marker").css('display','none');
					}
				}
			}
			//console.dir(self.viewport); 
			//console.log(self.viewport.getZoom);

		});


/*
	// 変化検知
	var imagingHelper = viewer.activateImagingHelper({onImageViewChanged: onImageViewChanged});
//alert(viewer.imagingHelper.getZoomFactor());

	viewer.addHandler('open', function(){
					//$("a.marker").css('display','block');
//alert(self.imagingHelper.getZoomFactor());
		onImageViewChanged();
	});
*/

	function onImageViewChanged(event) {
		//alert(self.imagingHelper.getZoomFactor());

		if(viewer.imagingHelper.getZoomFactor() > 0.5){
			if($('.markerOn').length){
					$("a.marker").css('display','block');
			}
		} else {
			$("a.marker").css('display','none');
		}


	}

</script>
</body>
</html>